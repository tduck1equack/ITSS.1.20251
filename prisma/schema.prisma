datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

// ========================================
// USER MANAGEMENT
// ========================================

enum UserRole {
  ADMINISTRATOR
  TEACHER
  STUDENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id          String     @id @default(cuid())
  email       String     @unique
  password    String // Should be hashed in production
  name        String
  studentCode String?    @unique // 8-9 digit code for students (e.g., 20211234, 202512345)
  avatar      String?
  role        UserRole   @default(STUDENT)
  status      UserStatus @default(ACTIVE)
  bio         String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  classTeachers            ClassTeacher[]             @relation("ClassTeachers")
  enrolledClasses          ClassEnrollment[]
  createdAssignments       Assignment[]
  submissions              AssignmentSubmission[]
  posts                    Post[]
  comments                 Comment[]
  postVotes                PostVote[]
  commentVotes             CommentVote[]
  attendanceRecords        Attendance[]
  attendanceCheckIns       AttendanceCheckIn[]        @relation("AttendanceCheckIns")
  notifications            Notification[]
  notificationSubscriptions NotificationSubscription[]
  groupMemberships         GroupMember[]
  createdGroups            Group[]                    @relation("GroupCreator")
  uploadedMaterials        LearningMaterial[]         @relation("UploadedMaterials")
  uploadedAttachments      ClassAttachment[]          @relation("AttachmentUploader")

  @@index([email])
  @@index([role])
  @@map("users")
}

// ========================================
// CLASS MANAGEMENT
// ========================================

enum ClassStatus {
  ACTIVE
  ARCHIVED
  DRAFT
}

model Class {
  id          String      @id @default(cuid())
  code        String      @unique // e.g., "CS101-2024"
  name        String
  description String?
  coverImage  String?
  status      ClassStatus @default(ACTIVE)
  semester    String? // e.g., "Fall 2024"
  year        Int?
  isPrivate   Boolean     @default(false) // Private classes require join code
  joinCode    String?     @unique // 8-character code for private classes (e.g., "AB12#CD3")
  createdBy   String? // Teacher who created this class
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  teachers         ClassTeacher[]
  enrollments      ClassEnrollment[]
  assignments      Assignment[]
  posts            Post[]
  attendance       Attendance[]
  attendanceSessions AttendanceSession[]
  groups           Group[]
  learningMaterials LearningMaterial[]
  attachments      ClassAttachment[]

  @@index([code])
  @@index([status])
  @@index([isPrivate])
  @@index([joinCode])
  @@map("classes")
}

// Many-to-many relationship between Class and Teachers
model ClassTeacher {
  id        String   @id @default(cuid())
  classId   String
  teacherId String
  role      String   @default("TEACHER") // TEACHER, CO_TEACHER, ASSISTANT
  addedAt   DateTime @default(now())

  // Relations
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher User  @relation("ClassTeachers", fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([classId, teacherId])
  @@index([classId])
  @@index([teacherId])
  @@map("class_teachers")
}

model ClassEnrollment {
  id         String   @id @default(cuid())
  classId    String
  studentId  String
  enrolledAt DateTime @default(now())
  status     String   @default("ACTIVE") // ACTIVE, DROPPED, COMPLETED

  // Relations
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
  @@map("class_enrollments")
}

// ========================================
// GROUPS
// ========================================

model Group {
  id          String   @id @default(cuid())
  classId     String
  name        String
  description String?
  maxMembers  Int?     // Optional limit on group size
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  class       Class         @relation(fields: [classId], references: [id], onDelete: Cascade)
  createdBy   User          @relation("GroupCreator", fields: [createdById], references: [id], onDelete: Cascade)
  members     GroupMember[]
  assignments Assignment[]

  @@index([classId])
  @@index([createdById])
  @@map("groups")
}

model GroupMember {
  id        String   @id @default(cuid())
  groupId   String
  studentId String
  joinedAt  DateTime @default(now())

  // Relations
  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([groupId, studentId])
  @@index([groupId])
  @@index([studentId])
  @@map("group_members")
}

// ========================================
// ASSIGNMENTS
// ========================================

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

model Assignment {
  id                   String           @id @default(cuid())
  classId              String
  groupId              String?          // Optional: if set, assignment is for specific group only
  title                String
  description          String?
  dueDate              DateTime
  maxPoints            Int              @default(100)
  status               AssignmentStatus @default(DRAFT)
  isSeparateSubmission Boolean          @default(true) // For group assignments: true = each member submits individually, false = one submission per group
  createdById          String
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  // Relations
  class       Class                  @relation(fields: [classId], references: [id], onDelete: Cascade)
  group       Group?                 @relation(fields: [groupId], references: [id], onDelete: SetNull)
  createdBy   User                   @relation(fields: [createdById], references: [id], onDelete: Cascade)
  submissions AssignmentSubmission[]
  attachments AssignmentAttachment[]

  @@index([classId])
  @@index([groupId])
  @@index([createdById])
  @@index([dueDate])
  @@map("assignments")
}

model AssignmentAttachment {
  id           String   @id @default(cuid())
  assignmentId String
  fileName     String
  fileUrl      String
  fileSize     Int?
  mimeType     String?
  uploadedAt   DateTime @default(now())

  // Relations
  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([assignmentId])
  @@map("assignment_attachments")
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  GRADED
  LATE
}

model AssignmentSubmission {
  id           String           @id @default(cuid())
  assignmentId String
  studentId    String
  groupId      String?          // For group submissions where isSeparateSubmission = false
  content      String?
  submittedAt  DateTime?
  status       SubmissionStatus @default(DRAFT)
  grade        Float?
  feedback     String?
  gradedAt     DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  assignment  Assignment                     @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student     User                           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  attachments AssignmentSubmissionAttachment[]

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([groupId])
  @@index([status])
  @@map("assignment_submissions")
}

model AssignmentSubmissionAttachment {
  id           String   @id @default(cuid())
  submissionId String
  fileName     String
  fileUrl      String
  fileSize     Int?
  mimeType     String?
  uploadedAt   DateTime @default(now())

  // Relations
  submission AssignmentSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@map("assignment_submission_attachments")
}

// ========================================
// POSTS & ANNOUNCEMENTS
// ========================================

enum PostType {
  ANNOUNCEMENT
  DISCUSSION
  MATERIAL
}

model Post {
  id                String   @id @default(cuid())
  classId           String
  authorId          String
  title             String
  content           String
  type              PostType @default(DISCUSSION)
  pinned            Boolean  @default(false)
  resolved          Boolean  @default(false)
  resolvedCommentId String?  // The comment marked as correct answer
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  class       Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  author      User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments    Comment[]
  votes       PostVote[]
  attachments PostAttachment[]

  @@index([classId])
  @@index([authorId])
  @@index([type])
  @@index([pinned])
  @@index([resolved])
  @@map("posts")
}

model PostAttachment {
  id         String   @id @default(cuid())
  postId     String
  fileName   String
  fileUrl    String
  fileSize   Int?
  mimeType   String?
  uploadedAt DateTime @default(now())

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("post_attachments")
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  authorId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  post        Post            @relation(fields: [postId], references: [id], onDelete: Cascade)
  author      User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  votes       CommentVote[]
  attachments CommentAttachment[]

  @@index([postId])
  @@index([authorId])
  @@map("comments")
}

model CommentAttachment {
  id         String   @id @default(cuid())
  commentId  String
  fileName   String
  fileUrl    String
  fileSize   Int?
  mimeType   String?
  uploadedAt DateTime @default(now())

  // Relations
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([commentId])
  @@map("comment_attachments")
}

model CommentVote {
  id        String   @id @default(cuid())
  commentId String
  userId    String
  voteType  VoteType
  createdAt DateTime @default(now())

  // Relations
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
  @@map("comment_votes")
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

model PostVote {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  voteType  VoteType
  createdAt DateTime @default(now())

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("post_votes")
}

model ClassAttachment {
  id         String   @id @default(cuid())
  classId    String
  uploaderId String
  fileName   String
  fileUrl    String
  fileSize   Int?
  mimeType   String?
  uploadedAt DateTime @default(now())

  // Relations
  class    Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  uploader User  @relation("AttachmentUploader", fields: [uploaderId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([uploaderId])
  @@map("class_attachments")
}

// ========================================
// ATTENDANCE
// ========================================

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum AttendanceSessionStatus {
  ACTIVE
  CLOSED
}

// Live attendance checking sessions
model AttendanceSession {
  id          String                  @id @default(cuid())
  classId     String
  title       String                  @default("Điểm danh")
  sessionCode String                  @unique // 6-digit code for students to check in
  status      AttendanceSessionStatus @default(ACTIVE)
  createdById String
  startTime   DateTime                @default(now())
  endTime     DateTime?
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  // Relations
  class       Class                    @relation(fields: [classId], references: [id], onDelete: Cascade)
  checkIns    AttendanceCheckIn[]

  @@index([classId])
  @@index([sessionCode])
  @@index([status])
  @@map("attendance_sessions")
}

// Records of students checking in to attendance sessions
model AttendanceCheckIn {
  id        String   @id @default(cuid())
  sessionId String
  studentId String
  checkedAt DateTime @default(now())

  // Relations
  session AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student User              @relation("AttendanceCheckIns", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@map("attendance_check_ins")
}

model Attendance {
  id        String           @id @default(cuid())
  classId   String
  studentId String
  date      DateTime
  status    AttendanceStatus @default(PRESENT)
  notes     String?
  markedAt  DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId, date])
  @@index([classId])
  @@index([studentId])
  @@index([date])
  @@map("attendance")
}

// ========================================
// LEARNING MATERIALS
// ========================================

enum MaterialType {
  VIDEO
  PDF
  DOCUMENT
  PRESENTATION
  SPREADSHEET
  IMAGE
  AUDIO
  OTHER
}

model LearningMaterial {
  id          String       @id @default(cuid())
  classId     String
  title       String
  description String?
  fileName    String
  fileUrl     String
  fileSize    Int?
  mimeType    String?
  materialType MaterialType
  uploadedById String
  downloadCount Int         @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  class      Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  uploadedBy User  @relation("UploadedMaterials", fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([uploadedById])
  @@index([materialType])
  @@map("learning_materials")
}

// ========================================
// NOTIFICATIONS & SUBSCRIPTIONS
// ========================================

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Flexible notification categories (can be extended without migration)
model NotificationCategory {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "ASSIGNMENT_CREATED", "SYSTEM_MAINTENANCE"
  name        String // Display name
  description String?
  icon        String? // Icon identifier for UI
  color       String? // Color code for UI
  priority    NotificationPriority @default(NORMAL)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  notifications  Notification[]
  subscriptions  NotificationSubscription[]

  @@index([code])
  @@index([isActive])
  @@map("notification_categories")
}

model Notification {
  id         String               @id @default(cuid())
  userId     String
  categoryId String
  title      String
  message    String
  link       String?
  priority   NotificationPriority @default(NORMAL)
  read       Boolean              @default(false)
  readAt     DateTime?
  
  // Metadata for flexible data storage
  metadata   Json? // Store additional context like { assignmentId, classId, etc. }
  
  createdAt  DateTime             @default(now())

  // Relations
  user     User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  category NotificationCategory   @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([categoryId])
  @@index([read])
  @@index([priority])
  @@index([createdAt])
  @@map("notifications")
}

// Subscriber pattern - users can subscribe to specific notification types
model NotificationSubscription {
  id         String   @id @default(cuid())
  userId     String
  categoryId String
  
  // Delivery channels
  inApp      Boolean  @default(true)
  email      Boolean  @default(false)
  push       Boolean  @default(false)
  
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user     User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  category NotificationCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId])
  @@index([categoryId])
  @@index([isActive])
  @@map("notification_subscriptions")
}

// ========================================
// LOCALIZATION SYSTEM
// ========================================

// Supported locales for the application
enum Locale {
  vi  // Vietnamese (default)
  ja  // Japanese
  en  // English (future)
}

// Entity types that support localization
enum LocalizableEntity {
  CLASS
  ASSIGNMENT
  POST
  LEARNING_MATERIAL
  GROUP
  NOTIFICATION_CATEGORY
}

// Central localization table for database content
// This enables multi-language support for user-generated or dynamic content
model Localization {
  id         String            @id @default(cuid())
  entityType LocalizableEntity // Type of entity being localized
  entityId   String            // ID of the entity (e.g., classId, assignmentId)
  locale     Locale            // Language code (vi, ja, en)
  field      String            // Field name being localized (e.g., "name", "description")
  value      String            @db.Text // Localized content
  
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@unique([entityType, entityId, locale, field]) // One translation per field per locale per entity
  @@index([entityType, entityId])
  @@index([locale])
  @@map("localizations")
}
