datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

// ========================================
// USER MANAGEMENT
// ========================================

enum UserRole {
  ADMINISTRATOR
  TEACHER
  STUDENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String // Should be hashed in production
  name      String
  avatar    String?
  role      UserRole   @default(STUDENT)
  status    UserStatus @default(ACTIVE)
  bio       String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  classTeachers            ClassTeacher[]             @relation("ClassTeachers")
  enrolledClasses          ClassEnrollment[]
  createdAssignments       Assignment[]
  submissions              AssignmentSubmission[]
  posts                    Post[]
  comments                 Comment[]
  postVotes                PostVote[]
  attendanceRecords        Attendance[]
  notifications            Notification[]
  notificationSubscriptions NotificationSubscription[]
  groupMemberships         GroupMember[]
  createdGroups            Group[]                    @relation("GroupCreator")
  uploadedMaterials        LearningMaterial[]         @relation("UploadedMaterials")

  @@index([email])
  @@index([role])
  @@map("users")
}

// ========================================
// CLASS MANAGEMENT
// ========================================

enum ClassStatus {
  ACTIVE
  ARCHIVED
  DRAFT
}

model Class {
  id          String      @id @default(cuid())
  code        String      @unique // e.g., "CS101-2024"
  name        String
  description String?
  coverImage  String?
  status      ClassStatus @default(ACTIVE)
  semester    String? // e.g., "Fall 2024"
  year        Int?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  teachers         ClassTeacher[]
  enrollments      ClassEnrollment[]
  assignments      Assignment[]
  posts            Post[]
  attendance       Attendance[]
  groups           Group[]
  learningMaterials LearningMaterial[]

  @@index([code])
  @@index([status])
  @@map("classes")
}

// Many-to-many relationship between Class and Teachers
model ClassTeacher {
  id        String   @id @default(cuid())
  classId   String
  teacherId String
  role      String   @default("TEACHER") // TEACHER, CO_TEACHER, ASSISTANT
  addedAt   DateTime @default(now())

  // Relations
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher User  @relation("ClassTeachers", fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([classId, teacherId])
  @@index([classId])
  @@index([teacherId])
  @@map("class_teachers")
}

model ClassEnrollment {
  id         String   @id @default(cuid())
  classId    String
  studentId  String
  enrolledAt DateTime @default(now())
  status     String   @default("ACTIVE") // ACTIVE, DROPPED, COMPLETED

  // Relations
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
  @@map("class_enrollments")
}

// ========================================
// GROUPS
// ========================================

model Group {
  id          String   @id @default(cuid())
  classId     String
  name        String
  description String?
  maxMembers  Int?     // Optional limit on group size
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  class       Class         @relation(fields: [classId], references: [id], onDelete: Cascade)
  createdBy   User          @relation("GroupCreator", fields: [createdById], references: [id], onDelete: Cascade)
  members     GroupMember[]
  assignments Assignment[]

  @@index([classId])
  @@index([createdById])
  @@map("groups")
}

model GroupMember {
  id        String   @id @default(cuid())
  groupId   String
  studentId String
  joinedAt  DateTime @default(now())

  // Relations
  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([groupId, studentId])
  @@index([groupId])
  @@index([studentId])
  @@map("group_members")
}

// ========================================
// ASSIGNMENTS
// ========================================

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

model Assignment {
  id          String           @id @default(cuid())
  classId     String
  groupId     String?          // Optional: if set, assignment is for specific group only
  title       String
  description String?
  dueDate     DateTime
  maxPoints   Int              @default(100)
  status      AssignmentStatus @default(DRAFT)
  createdById String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  class       Class                  @relation(fields: [classId], references: [id], onDelete: Cascade)
  group       Group?                 @relation(fields: [groupId], references: [id], onDelete: SetNull)
  createdBy   User                   @relation(fields: [createdById], references: [id], onDelete: Cascade)
  submissions AssignmentSubmission[]
  attachments AssignmentAttachment[]

  @@index([classId])
  @@index([groupId])
  @@index([createdById])
  @@index([dueDate])
  @@map("assignments")
}

model AssignmentAttachment {
  id           String   @id @default(cuid())
  assignmentId String
  fileName     String
  fileUrl      String
  fileSize     Int?
  mimeType     String?
  uploadedAt   DateTime @default(now())

  // Relations
  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([assignmentId])
  @@map("assignment_attachments")
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  GRADED
  LATE
}

model AssignmentSubmission {
  id           String           @id @default(cuid())
  assignmentId String
  studentId    String
  content      String?
  submittedAt  DateTime?
  status       SubmissionStatus @default(DRAFT)
  grade        Float?
  feedback     String?
  gradedAt     DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  assignment  Assignment                     @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student     User                           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  attachments AssignmentSubmissionAttachment[]

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
  @@map("assignment_submissions")
}

model AssignmentSubmissionAttachment {
  id           String   @id @default(cuid())
  submissionId String
  fileName     String
  fileUrl      String
  fileSize     Int?
  mimeType     String?
  uploadedAt   DateTime @default(now())

  // Relations
  submission AssignmentSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@map("assignment_submission_attachments")
}

// ========================================
// POSTS & ANNOUNCEMENTS
// ========================================

enum PostType {
  ANNOUNCEMENT
  DISCUSSION
  MATERIAL
}

model Post {
  id        String   @id @default(cuid())
  classId   String
  authorId  String
  title     String
  content   String
  type      PostType @default(DISCUSSION)
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  class       Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  author      User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments    Comment[]
  votes       PostVote[]
  attachments PostAttachment[]

  @@index([classId])
  @@index([authorId])
  @@index([type])
  @@index([pinned])
  @@map("posts")
}

model PostAttachment {
  id         String   @id @default(cuid())
  postId     String
  fileName   String
  fileUrl    String
  fileSize   Int?
  mimeType   String?
  uploadedAt DateTime @default(now())

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("post_attachments")
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  authorId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([authorId])
  @@map("comments")
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

model PostVote {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  voteType  VoteType
  createdAt DateTime @default(now())

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("post_votes")
}

// ========================================
// ATTENDANCE
// ========================================

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

model Attendance {
  id        String           @id @default(cuid())
  classId   String
  studentId String
  date      DateTime
  status    AttendanceStatus @default(PRESENT)
  notes     String?
  markedAt  DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId, date])
  @@index([classId])
  @@index([studentId])
  @@index([date])
  @@map("attendance")
}

// ========================================
// LEARNING MATERIALS
// ========================================

enum MaterialType {
  VIDEO
  PDF
  DOCUMENT
  PRESENTATION
  SPREADSHEET
  IMAGE
  AUDIO
  OTHER
}

model LearningMaterial {
  id          String       @id @default(cuid())
  classId     String
  title       String
  description String?
  fileName    String
  fileUrl     String
  fileSize    Int?
  mimeType    String?
  materialType MaterialType
  uploadedById String
  downloadCount Int         @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  class      Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  uploadedBy User  @relation("UploadedMaterials", fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([uploadedById])
  @@index([materialType])
  @@map("learning_materials")
}

// ========================================
// NOTIFICATIONS & SUBSCRIPTIONS
// ========================================

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Flexible notification categories (can be extended without migration)
model NotificationCategory {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "ASSIGNMENT_CREATED", "SYSTEM_MAINTENANCE"
  name        String // Display name
  description String?
  icon        String? // Icon identifier for UI
  color       String? // Color code for UI
  priority    NotificationPriority @default(NORMAL)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  notifications  Notification[]
  subscriptions  NotificationSubscription[]

  @@index([code])
  @@index([isActive])
  @@map("notification_categories")
}

model Notification {
  id         String               @id @default(cuid())
  userId     String
  categoryId String
  title      String
  message    String
  link       String?
  priority   NotificationPriority @default(NORMAL)
  read       Boolean              @default(false)
  readAt     DateTime?
  
  // Metadata for flexible data storage
  metadata   Json? // Store additional context like { assignmentId, classId, etc. }
  
  createdAt  DateTime             @default(now())

  // Relations
  user     User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  category NotificationCategory   @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([categoryId])
  @@index([read])
  @@index([priority])
  @@index([createdAt])
  @@map("notifications")
}

// Subscriber pattern - users can subscribe to specific notification types
model NotificationSubscription {
  id         String   @id @default(cuid())
  userId     String
  categoryId String
  
  // Delivery channels
  inApp      Boolean  @default(true)
  email      Boolean  @default(false)
  push       Boolean  @default(false)
  
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user     User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  category NotificationCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId])
  @@index([categoryId])
  @@index([isActive])
  @@map("notification_subscriptions")
}